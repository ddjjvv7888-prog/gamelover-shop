<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameLover ADMIN V2</title>
    <style>
        :root { --primary: #4b0082; --accent: #ffd700; --bg: #f3e5f5; --text: #333; --green: #00d26a; --red: #ff4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: var(--primary); text-align: center; border-bottom: 4px solid var(--accent); padding-bottom: 10px; }
        
        /* LOGIN BOX */
        #login-box { max-width: 300px; margin: 100px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; }
        button:hover { opacity: 0.9; }

        /* DASHBOARD GRID */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; display: none; }
        
        .panel { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: 500px; overflow-y: auto; }
        h2 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; }

        /* LIST ITEMS */
        .item { border-bottom: 1px solid #eee; padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .item:last-child { border-bottom: none; }
        .info { font-size: 0.9rem; }
        .info b { color: var(--primary); }
        .price { font-weight: bold; font-size: 1.1rem; color: var(--green); }
        .time { font-size: 0.75rem; color: #888; margin-top: 5px; }

        /* ACTIONS */
        .actions { display: flex; gap: 5px; }
        .btn-approve { background: var(--green); padding: 5px 10px; font-size: 0.8rem; }
        .btn-deny { background: var(--red); padding: 5px 10px; font-size: 0.8rem; }
        
        /* USER SEARCH */
        .user-manager { grid-column: 1 / -1; height: auto; }
        .search-bar { display: flex; gap: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ðŸ‘¾ Admin Dashboard V2</h1>

        <div id="login-box">
            <h3>Admin Login</h3>
            <input type="email" id="admin-email" placeholder="Email">
            <input type="password" id="admin-pass" placeholder="Password">
            <button onclick="doLogin()">Enter Dashboard</button>
            <p id="status" style="font-size:0.8rem; color:red; margin-top:10px;"></p>
        </div>

        <div id="dashboard" class="dashboard">
            
            <div class="panel">
                <h2>ðŸ’° Pending Deposits</h2>
                <div id="deposit-list">Loading...</div>
            </div>

            <div class="panel">
                <h2>ðŸŽ® New Orders</h2>
                <div id="order-list">Loading...</div>
            </div>

            <div class="panel user-manager">
                <h2>ðŸ‘¤ User Manager</h2>
                <div class="search-bar">
                    <input type="text" id="search-uid" placeholder="Enter User UID or Email to edit balance...">
                    <button style="width:auto;" onclick="searchUser()">Search</button>
                </div>
                <div id="user-result" style="padding:10px; background:#f9f9f9; border-radius:10px; display:none;">
                    <p><strong>Email:</strong> <span id="u-email">...</span></p>
                    <p><strong>UID:</strong> <span id="u-uid" style="font-family:monospace;">...</span></p>
                    <p><strong>Current Balance:</strong> <span id="u-bal" style="color:var(--green); font-weight:bold;">...</span></p>
                    <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
                        <input type="number" id="new-bal" placeholder="New Balance" style="width:150px; margin:0;">
                        <button style="width:auto; background:var(--accent); color:var(--primary);" onclick="updateBalance()">Update Balance</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc, increment, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyBZoKyWmeNSELvqVm8barRKp3alPy-GdGk",
        authDomain: "gamelovershop-d3b47.firebaseapp.com",
        projectId: "gamelovershop-d3b47",
        storageBucket: "gamelovershop-d3b47.firebasestorage.app",
        messagingSenderId: "782424722391",
        appId: "1:782424722391:web:41a9cbbf897c3ad1dd1992"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const ADMIN_UID = "YY1ZvwkU3ePdOxRZtGT2GqBZ3bi2"; // YOUR ID

    // --- LOGIN LOGIC ---
    window.doLogin = async () => {
        const e = document.getElementById('admin-email').value;
        const p = document.getElementById('admin-pass').value;
        try {
            await signInWithEmailAndPassword(auth, e, p);
        } catch(err) {
            document.getElementById('status').innerText = "Login Failed: " + err.message;
        }
    };

    onAuthStateChanged(auth, (user) => {
        if(user && user.uid === ADMIN_UID) {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('dashboard').style.display = 'grid';
            startListeners();
        } else if (user) {
            document.getElementById('status').innerText = "ACCESS DENIED: You are not the Admin.";
            auth.signOut();
        }
    });

    // --- REAL-TIME LISTENERS ---
    function startListeners() {
        
        // 1. WATCH DEPOSITS
        const qDep = query(collection(db, "requests"), where("type", "==", "DEPOSIT"), where("status", "==", "PENDING"), orderBy("timestamp", "desc"));
        onSnapshot(qDep, (snap) => {
            const list = document.getElementById('deposit-list');
            list.innerHTML = "";
            if(snap.empty) list.innerHTML = "<p style='text-align:center; color:#ccc'>No pending deposits.</p>";
            
            snap.forEach(docSnap => {
                const d = docSnap.data();
                const id = docSnap.id;
                const time = d.timestamp ? d.timestamp.toDate().toLocaleString() : "...";
                
                list.innerHTML += `
                    <div class="item">
                        <div class="info">
                            <b>${d.email}</b><br>
                            UID: <span style="font-family:monospace; font-size:0.8rem">${d.userId}</span><br>
                            Ref: <b style="background:yellow; padding:2px;">${d.refNo}</b>
                            <div class="time">${time}</div>
                        </div>
                        <div style="text-align:right">
                            <div class="price">+${d.amount} G</div>
                            <div class="actions">
                                <button class="btn-approve" onclick="window.processDeposit('${id}', '${d.userId}', ${d.amount})">âœ” Confirm</button>
                                <button class="btn-deny" onclick="window.rejectRequest('${id}')">âœ– Deny</button>
                            </div>
                        </div>
                    </div>`;
            });
        });

        // 2. WATCH ORDERS
        const qOrd = query(collection(db, "requests"), where("type", "==", "ORDER"), where("status", "==", "PROCESSING"), orderBy("timestamp", "desc"));
        onSnapshot(qOrd, (snap) => {
            const list = document.getElementById('order-list');
            list.innerHTML = "";
            if(snap.empty) list.innerHTML = "<p style='text-align:center; color:#ccc'>No new orders.</p>";
            
            snap.forEach(docSnap => {
                const d = docSnap.data();
                const id = docSnap.id;
                const time = d.timestamp ? d.timestamp.toDate().toLocaleString() : "...";
                
                list.innerHTML += `
                    <div class="item">
                        <div class="info">
                            <b>${d.game}</b> (${d.item})<br>
                            Player ID: <b>${d.playerId}</b><br>
                            Zone: <b>${d.zoneId}</b>
                            <div class="time">${time}</div>
                        </div>
                        <div style="text-align:right">
                            <div class="price" style="color:#333">${d.price} G</div>
                            <div class="actions">
                                <button class="btn-approve" style="background:var(--primary)" onclick="window.completeOrder('${id}')">âœ” Sent</button>
                                <button class="btn-deny" onclick="window.rejectRequest('${id}')">âœ– Reject</button>
                            </div>
                        </div>
                    </div>`;
            });
        });
    }

    // --- GLOBAL ACTIONS ---
    
    // A. APPROVE DEPOSIT (Adds Money + Closes Ticket)
    window.processDeposit = async (reqId, userId, amount) => {
        if(!confirm(`Add ${amount} G to this user?`)) return;
        try {
            // 1. Add Money
            await updateDoc(doc(db, "users", userId), {
                balance: increment(amount)
            });
            // 2. Close Ticket
            await updateDoc(doc(db, "requests", reqId), { status: "COMPLETED" });
            alert("Success! Balance Updated.");
        } catch(e) { alert("Error: " + e.message); }
    };

    // B. COMPLETE ORDER (Closes Ticket Only - Money already taken)
    window.completeOrder = async (reqId) => {
        try {
            await updateDoc(doc(db, "requests", reqId), { status: "COMPLETED" });
        } catch(e) { alert("Error: " + e.message); }
    };

    // C. REJECT ANY REQUEST
    window.rejectRequest = async (reqId) => {
        if(!confirm("Reject this request?")) return;
        try {
            await updateDoc(doc(db, "requests", reqId), { status: "REJECTED" });
        } catch(e) { alert("Error: " + e.message); }
    };

    // D. USER SEARCH & EDIT
    let currentEditUid = null;
    
    window.searchUser = async () => {
        const input = document.getElementById('search-uid').value.trim();
        if(!input) return alert("Enter UID or Email");
        
        let foundDoc = null;
        
        // Try searching by Email first (Requires Index, might fail if not set up, so fallback to UID)
        try {
            const q = query(collection(db, "users"), where("email", "==", input));
            const snap = await getDocs(q);
            if(!snap.empty) foundDoc = snap.docs[0];
        } catch(e) { console.log("Email search failed, trying UID..."); }

        // Try searching by UID
        if(!foundDoc) {
            const snap = await getDoc(doc(db, "users", input));
            if(snap.exists()) foundDoc = snap;
        }

        if(foundDoc) {
            const data = foundDoc.data();
            currentEditUid = foundDoc.id;
            
            document.getElementById('u-email').innerText = data.email || "No Email";
            document.getElementById('u-uid').innerText = foundDoc.id;
            document.getElementById('u-bal').innerText = (data.balance || 0) + " G";
            
            document.getElementById('user-result').style.display = 'block';
        } else {
            alert("User not found!");
            document.getElementById('user-result').style.display = 'none';
        }
    };

    window.updateBalance = async () => {
        if(!currentEditUid) return;
        const newBal = parseInt(document.getElementById('new-bal').value);
        if(isNaN(newBal)) return alert("Enter a valid number");
        
        if(confirm(`Change balance to ${newBal} G?`)) {
            await updateDoc(doc(db, "users", currentEditUid), { balance: newBal });
            alert("Balance Updated!");
            document.getElementById('u-bal').innerText = newBal + " G";
        }
    };

</script>
</body>
</html>
