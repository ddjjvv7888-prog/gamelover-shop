<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameLover Admin Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --primary: #4b0082; --accent: #ffd700; --bg: #f4f6f8; --green: #2ecc71; --red: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; }
        
        /* Header */
        header { background: var(--primary); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        
        /* Search Bar */
        .search-box { padding: 15px; border-bottom: 1px solid #eee; background: #fff; display: flex; gap: 10px; }
        .search-box input { flex: 1; padding: 10px; border: 2px solid #eee; border-radius: 6px; font-size: 1rem; }
        .search-box input:focus { outline: none; border-color: var(--primary); }

        /* Tabs */
        .tabs { display: flex; background: #eee; cursor: pointer; }
        .tab { flex: 1; padding: 15px; text-align: center; font-weight: bold; color: #777; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab:hover { background: #ddd; }
        .tab.active { background: white; color: var(--primary); border-bottom-color: var(--primary); }
        .badge { background: var(--red); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8rem; margin-left: 5px; }

        /* Lists */
        .panel { display: none; padding: 20px; }
        .panel.active { display: block; }
        
        .card { display: flex; justify-content: space-between; align-items: center; background: white; border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid #ccc; transition: 0.2s; }
        .card:hover { transform: translateX(5px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .card.deposit { border-left-color: var(--green); }
        .card.order { border-left-color: var(--primary); }

        .info h4 { margin: 0 0 5px 0; color: #333; }
        .info p { margin: 0; color: #666; font-size: 0.9rem; }
        .meta { font-family: monospace; color: #888; background: #eee; padding: 2px 5px; border-radius: 4px; }
        
        .actions { display: flex; gap: 5px; }
        button { border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-approve { background: var(--green); }
        .btn-reject { background: var(--red); }
        .btn-copy { background: #3498db; }

        /* Login */
        #login-screen { text-align: center; padding: 50px; }
        #login-screen input { padding: 10px; width: 60%; margin: 10px 0; display: block; margin-left: auto; margin-right: auto; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1><i class="fas fa-user-shield"></i> Owner Dashboard</h1>
        <button onclick="auth.signOut(); location.reload();" style="background:rgba(255,255,255,0.2);">Log Out</button>
    </header>

    <div id="login-screen">
        <h2>Restricted Access</h2>
        <input type="email" id="admin-email" placeholder="Admin Email">
        <input type="password" id="admin-pass" placeholder="Password">
        <button onclick="adminLogin()" style="background:var(--primary); width: 62%; padding: 12px;">Login</button>
    </div>

    <div id="dashboard-screen" style="display:none;">
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search by Email, UID, or Ref No..." onkeyup="filterList()">
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('deposits')">
                ðŸ’° Deposits <span id="dep-count" class="badge">0</span>
            </div>
            <div class="tab" onclick="switchTab('orders')">
                ðŸŽ® Orders <span id="ord-count" class="badge">0</span>
            </div>
        </div>

        <div id="panel-deposits" class="panel active">
            <p style="color:#666; font-style:italic;">Check your Bank App for these Transaction IDs before approving.</p>
            <div id="deposit-list">Loading...</div>
        </div>

        <div id="panel-orders" class="panel">
            <p style="color:#666; font-style:italic;">Purchase these items in MooGold/Supplier and mark as Done.</p>
            <div id="order-list">Loading...</div>
        </div>

    </div>
</div>

<script>
// --- FIREBASE CONFIGURATION (PASTE YOUR KEYS HERE) ---
const firebaseConfig = {
apiKey: "AIzaSyBZoKyWmeNSELvqVm8barRKp3alPy-GdGk",
authDomain: "gamelovershop-d3b47.firebaseapp.com",
projectId: "gamelovershop-d3b47",
storageBucket: "gamelovershop-d3b47.firebasestorage.app",
messagingSenderId: "782424722391",
appId: "1:782424722391:web:41a9cbbf897c3ad1dd1992"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- AUTH ---
    auth.onAuthStateChanged(user => {
        if(user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard-screen').style.display = 'block';
            loadData();
        }
    });

    function adminLogin() {
        const e = document.getElementById('admin-email').value;
        const p = document.getElementById('admin-pass').value;
        auth.signInWithEmailAndPassword(e, p).catch(err => alert("Login Failed: " + err.message));
    }

    // --- TABS LOGIC ---
    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        
        if(tabName === 'deposits') {
            document.querySelector('.tab:nth-child(1)').classList.add('active');
            document.getElementById('panel-deposits').classList.add('active');
        } else {
            document.querySelector('.tab:nth-child(2)').classList.add('active');
            document.getElementById('panel-orders').classList.add('active');
        }
    }

    // --- LOAD DATA ---
    function loadData() {
        // Load Deposits
        db.collection("requests").where("type", "==", "DEPOSIT").where("status", "==", "PENDING")
        .onSnapshot(snap => {
            const list = document.getElementById('deposit-list');
            document.getElementById('dep-count').innerText = snap.size;
            list.innerHTML = "";
            if(snap.empty) list.innerHTML = "<p>No pending deposits.</p>";
            
            snap.forEach(doc => {
                const d = doc.data();
                const card = document.createElement('div');
                card.className = 'card deposit search-item';
                card.innerHTML = `
                    <div class="info">
                        <h4>${d.email}</h4>
                        <p>Request: <b style="color:var(--green)">+${d.amount} G</b></p>
                        <span class="meta">Ref: ${d.refNo || "No Ref"}</span>
                    </div>
                    <div class="actions">
                        <button class="btn-approve" onclick="approveDeposit('${doc.id}', '${d.userId}', ${d.amount})">âœ” Confirm</button>
                        <button class="btn-reject" onclick="deleteReq('${doc.id}')">âœ–</button>
                    </div>
                `;
                list.appendChild(card);
            });
        });

        // Load Orders
        db.collection("requests").where("type", "==", "ORDER").where("status", "==", "PROCESSING") // Or PENDING
        .onSnapshot(snap => {
            const list = document.getElementById('order-list');
            document.getElementById('ord-count').innerText = snap.size;
            list.innerHTML = "";
            if(snap.empty) list.innerHTML = "<p>No pending orders.</p>";

            snap.forEach(doc => {
                const d = doc.data();
                const card = document.createElement('div');
                card.className = 'card order search-item';
                card.innerHTML = `
                    <div class="info">
                        <h4>${d.game} - ${d.item}</h4>
                        <p>User: ${d.email}</p>
                        <p class="meta">UID: ${d.playerId} | Zone: ${d.zoneId}</p>
                    </div>
                    <div class="actions">
                        <button class="btn-copy" onclick="navigator.clipboard.writeText('${d.playerId}')">Copy UID</button>
                        <button class="btn-approve" onclick="completeOrder('${doc.id}')">âœ” Done</button>
                    </div>
                `;
                list.appendChild(card);
            });
        });
    }

    // --- SEARCH FILTER ---
    function filterList() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.search-item').forEach(item => {
            const text = item.innerText.toLowerCase();
            item.style.display = text.includes(term) ? 'flex' : 'none';
        });
    }

async function approveDeposit(reqId, userId, amount) {
        // 1. Ask for confirmation first
        if(!confirm(`Confirm Ref matches Bank? Add ${amount} G?`)) return;
        
        try {
            const userRef = db.collection("users").doc(userId);
            const reqRef = db.collection("requests").doc(reqId);
            
            await db.runTransaction(async (t) => {
                // 2. READ both documents first
                const reqDoc = await t.get(reqRef);
                const userDoc = await t.get(userRef);
                
                // 3. THE SAFETY CHECK (Stops the double-tap)
                if(!reqDoc.exists) throw "Request not found!";
                if(reqDoc.data().status === "COMPLETED") {
                    throw "STOP! This order was already processed.";
                }

                // 4. Calculate new balance
                const oldBal = Number(userDoc.data()?.balance || 0);
                const newBal = oldBal + Number(amount);
                
                // 5. Update both (Balance & Status)
                // Note: using set with merge to ensure we don't overwrite other user data
                t.set(userRef, { balance: newBal }, { merge: true });
                t.update(reqRef, { status: "COMPLETED" });
            });
            
            alert("Success! Balance Updated.");
            
        } catch(e) { 
            // If it was a double-tap, this error will pop up
            console.error(e);
            alert("Notice: " + (e.message || e)); 
        }
    }

    function completeOrder(reqId) {
        if(confirm("Have you sent the items?")) {
            db.collection("requests").doc(reqId).update({ status: "COMPLETED" });
        }
    }

    function deleteReq(reqId) {
        if(confirm("Reject and Delete this request?")) {
            db.collection("requests").doc(reqId).delete();
        }
    }
</script>

</body>
</html>



