<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameLover ADMIN V3.1</title>
    <style>
        :root { --primary: #4b0082; --accent: #ffd700; --bg: #f3e5f5; --text: #333; --green: #00d26a; --red: #ff4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: var(--primary); text-align: center; border-bottom: 4px solid var(--accent); padding-bottom: 10px; }
        
        /* LOGIN BOX */
        #login-box { max-width: 300px; margin: 100px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; }
        button:hover { opacity: 0.9; }

        /* DASHBOARD GRID */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; display: none; }
        
        .panel { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: 500px; overflow-y: auto; }
        h2 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; font-size:1.2rem; }

        .item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .info { font-size: 0.85rem; margin-bottom: 5px; }
        .info b { color: var(--primary); }
        .price { font-weight: bold; font-size: 1rem; color: var(--green); float: right; }
        
        .actions { display: flex; gap: 5px; margin-top: 10px; }
        .btn-approve { background: var(--green); padding: 5px 10px; font-size: 0.8rem; flex: 1; border:none; color:white; border-radius:5px; cursor:pointer; }
        .btn-deny { background: var(--red); padding: 5px 10px; font-size: 0.8rem; flex: 1; border:none; color:white; border-radius:5px; cursor:pointer; }
        
        .user-manager { grid-column: 1 / -1; height: auto; }
        .search-bar { display: flex; gap: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ðŸ‘¾ Admin Dashboard V3.1</h1>

        <div id="login-box">
            <h3>Admin Login</h3>
            <input type="email" id="admin-email" placeholder="Email">
            <input type="password" id="admin-pass" placeholder="Password">
            <button onclick="doLogin()">Enter Dashboard</button>
            <p id="status" style="font-size:0.8rem; color:red; margin-top:10px;"></p>
        </div>

        <div id="dashboard" class="dashboard">
            
            <div class="panel">
                <h2>ðŸ’° Pending Deposits</h2>
                <div id="deposit-list">Loading...</div>
            </div>

            <div class="panel">
                <h2>ðŸŽ® New Orders</h2>
                <div id="order-list">Loading...</div>
            </div>

            <div class="panel">
                <h2>ðŸ’¸ P2P Transfers</h2>
                <div id="transfer-list">Loading...</div>
            </div>

            <div class="panel user-manager">
                <h2>ðŸ‘¤ User Manager</h2>
                <div class="search-bar">
                    <input type="text" id="search-uid" placeholder="Enter User UID or Email...">
                    <button style="width:auto;" onclick="searchUser()">Search</button>
                </div>
                <div id="user-result" style="padding:10px; background:#f9f9f9; border-radius:10px; display:none;">
                    <p><strong>Email:</strong> <span id="u-email">...</span></p>
                    <p><strong>UID:</strong> <span id="u-uid" style="font-family:monospace;">...</span></p>
                    <p><strong>Current Balance:</strong> <span id="u-bal" style="color:var(--green); font-weight:bold;">...</span></p>
                    <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
                        <input type="number" id="new-bal" placeholder="New Balance" style="width:150px; margin:0;">
                        <button style="width:auto; background:var(--accent); color:var(--primary);" onclick="updateBalance()">Update Balance</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc, increment, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBZoKyWmeNSELvqVm8barRKp3alPy-GdGk",
        authDomain: "gamelovershop-d3b47.firebaseapp.com",
        projectId: "gamelovershop-d3b47",
        storageBucket: "gamelovershop-d3b47.firebasestorage.app",
        messagingSenderId: "782424722391",
        appId: "1:782424722391:web:41a9cbbf897c3ad1dd1992"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const ADMIN_UID = "YY1ZvwkU3ePdOxRZtGT2GqBZ3bi2"; 

    window.doLogin = async () => {
        try { await signInWithEmailAndPassword(auth, document.getElementById('admin-email').value, document.getElementById('admin-pass').value); } 
        catch(err) { document.getElementById('status').innerText = "Login Failed: " + err.message; }
    };

    onAuthStateChanged(auth, (user) => {
        if(user && user.uid === ADMIN_UID) {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('dashboard').style.display = 'grid';
            startListeners();
        } else if (user) {
            document.getElementById('status').innerText = "ACCESS DENIED.";
            auth.signOut();
        }
    });

    function startListeners() {
        
        // 1. DEPOSITS
        const qDep = query(collection(db, "requests"), where("type", "==", "DEPOSIT"), where("status", "==", "PENDING"), orderBy("timestamp", "desc"));
        onSnapshot(qDep, (snap) => {
            const list = document.getElementById('deposit-list');
            list.innerHTML = "";
            if(snap.empty) list.innerHTML = "<p style='color:#ccc'>No pending deposits.</p>";
            snap.forEach(docSnap => {
                const d = docSnap.data();
                // Pass 'DEPOSIT' and 0 (no refund needed)
                list.innerHTML += `
                    <div class="item">
                        <div class="price">+${d.amount} G</div>
                        <div class="info"><b>${d.email}</b><br>Ref: <b style="background:yellow; padding:2px;">${d.refNo}</b></div>
                        <div class="actions">
                            <button class="btn-approve" onclick="window.processDeposit('${docSnap.id}', '${d.userId}', ${d.amount})">âœ” Confirm</button>
                            <button class="btn-deny" onclick="window.rejectRequest('${docSnap.id}', 'DEPOSIT', '${d.userId}', 0)">âœ– Deny</button>
                        </div>
                    </div>`;
            });
        });

        // 2. ORDERS
        const qOrd = query(collection(db, "requests"), where("type", "==", "ORDER"), where("status", "==", "PROCESSING"), orderBy("timestamp", "desc"));
        onSnapshot(qOrd, (snap) => {
            const list = document.getElementById('order-list');
            list.innerHTML = "";
            if(snap.empty) list.innerHTML = "<p style='color:#ccc'>No new orders.</p>";
            snap.forEach(docSnap => {
                const d = docSnap.data();
                // Pass 'ORDER' and d.price (Refund Price)
                list.innerHTML += `
                    <div class="item">
                        <div class="price" style="color:#333">${d.price} G</div>
                        <div class="info"><b>${d.game}</b> (${d.item})<br>UID: <b>${d.playerId}</b> | Zone: ${d.zoneId}</div>
                        <div class="actions">
                            <button class="btn-approve" style="background:var(--primary)" onclick="window.completeOrder('${docSnap.id}')">âœ” Sent</button>
                            <button class="btn-deny" onclick="window.rejectRequest('${docSnap.id}', 'ORDER', '${d.userId}', ${d.price})">âœ– Reject</button>
                        </div>
                    </div>`;
            });
        });

        // 3. TRANSFERS
        const qTrans = query(collection(db, "requests"), where("type", "==", "TRANSFER"), where("status", "==", "PROCESSING"), orderBy("timestamp", "desc"));
        onSnapshot(qTrans, (snap) => {
            const list = document.getElementById('transfer-list');
            list.innerHTML = "";
            if(snap.empty) list.innerHTML = "<p style='color:#ccc'>No transfers.</p>";
            snap.forEach(docSnap => {
                const d = docSnap.data();
                // Pass 'TRANSFER' and d.amount (Refund Amount)
                list.innerHTML += `
                    <div class="item">
                        <div class="price" style="color:blue">${d.amount} G</div>
                        <div class="info">
                            From: <b>${d.email}</b><br>
                            To: <b style="background:#e0f7fa; padding:2px;">${d.target}</b>
                        </div>
                        <div class="actions">
                            <button class="btn-approve" onclick="window.processTransfer('${docSnap.id}', '${d.target}', ${d.amount})">âœ” Approve</button>
                            <button class="btn-deny" onclick="window.rejectRequest('${docSnap.id}', 'TRANSFER', '${d.userId}', ${d.amount})">âœ– Reject</button>
                        </div>
                    </div>`;
            });
        });
    }

    // --- ACTIONS ---

    // A. DEPOSIT
    window.processDeposit = async (reqId, userId, amount) => {
        if(!confirm(`Add ${amount} G to this user?`)) return;
        try {
            await updateDoc(doc(db, "users", userId), { balance: increment(amount) });
            await updateDoc(doc(db, "requests", reqId), { status: "COMPLETED" });
        } catch(e) { alert("Error: " + e.message); }
    };

    // B. ORDER
    window.completeOrder = async (reqId) => {
        try { await updateDoc(doc(db, "requests", reqId), { status: "COMPLETED" }); } 
        catch(e) { alert("Error: " + e.message); }
    };

    // C. TRANSFER (P2P)
    window.processTransfer = async (reqId, targetIdentifier, amount) => {
        // 1. Find Receiver
        let targetUid = null;
        
        // Check if target is UID
        const uSnap = await getDoc(doc(db, "users", targetIdentifier));
        if(uSnap.exists()) { targetUid = targetIdentifier; }
        else {
            // Check if target is Email
            const q = query(collection(db, "users"), where("email", "==", targetIdentifier));
            const qSnap = await getDocs(q);
            if(!qSnap.empty) targetUid = qSnap.docs[0].id;
        }

        if(!targetUid) return alert("Receiver Not Found! Please Reject/Refund.");

        if(confirm(`Transfer ${amount} G to ${targetIdentifier}?`)) {
            try {
                // Add money to receiver
                await updateDoc(doc(db, "users", targetUid), { balance: increment(amount) });
                // Mark complete
                await updateDoc(doc(db, "requests", reqId), { status: "COMPLETED" });
                alert("Transfer Successful!");
            } catch(e) { alert("Error: " + e.message); }
        }
    };

    // D. SMART REJECT (AUTO-REFUND LOGIC)
    window.rejectRequest = async (reqId, type, userId, refundValue) => {
        if(!confirm("Reject this request? (Funds will be refunded automatically)")) return;
        
        try {
            // 1. If it was an ORDER or TRANSFER, the user already paid. GIVE IT BACK!
            if(type === "ORDER" || type === "TRANSFER") {
                if(refundValue > 0) {
                    await updateDoc(doc(db, "users", userId), { balance: increment(refundValue) });
                    alert(`Rejected. Refunded ${refundValue} G to the user.`);
                }
            }

            // 2. Mark ticket as REJECTED
            await updateDoc(doc(db, "requests", reqId), { status: "REJECTED" });

        } catch(e) { alert("Error: " + e.message); }
    };

    // E. USER SEARCH
    window.searchUser = async () => {
        const input = document.getElementById('search-uid').value.trim();
        let foundDoc = null;
        try {
            const q = query(collection(db, "users"), where("email", "==", input));
            const snap = await getDocs(q);
            if(!snap.empty) foundDoc = snap.docs[0];
        } catch(e) {}
        if(!foundDoc) {
            const snap = await getDoc(doc(db, "users", input));
            if(snap.exists()) foundDoc = snap;
        }
        if(foundDoc) {
            const data = foundDoc.data();
            document.getElementById('u-email').innerText = data.email;
            document.getElementById('u-uid').innerText = foundDoc.id;
            document.getElementById('u-bal').innerText = (data.balance || 0) + " G";
            document.getElementById('user-result').style.display = 'block';
            window.currentEditUid = foundDoc.id;
        } else { alert("User not found!"); }
    };
    
    window.updateBalance = async () => {
        if(!window.currentEditUid) return;
        const newBal = parseInt(document.getElementById('new-bal').value);
        if(confirm(`Update balance?`)) {
            await updateDoc(doc(db, "users", window.currentEditUid), { balance: newBal });
            alert("Updated!");
            document.getElementById('u-bal').innerText = newBal + " G";
        }
    };

</script>
</body>
</html>
